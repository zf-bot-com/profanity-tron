name: "Build And Release"

on:
  push:
    branches:
      - main
      
jobs:
  build_for_windows:
    name: "Build for Windows"
    runs-on: [windows-2022]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: 2022
          
      - name: "Build"
        shell: cmd
        run: |
          cl.exe /c /I"${{ github.workspace }}\Curl\include" /I"${{ github.workspace }}\OpenCL\include" /Zi /nologo /W1 /WX- /diagnostics:column /O2 /D BUILDING_LIBCURL /D HTTP_ONLY /Gm- /EHsc /MD /GS /fp:precise /Zc:wchar_t /Zc:forScope /Zc:inline /Fo"${{ github.workspace }}\dist\\" /Fe"${{ github.workspace }}\dist\\" /external:W1 /Gd /TP /FC /errorReport:prompt Dispatcher.cpp Mode.cpp precomp.cpp profanity.cpp SpeedSample.cpp
          link.exe /ERRORREPORT:PROMPT /OUT:"${{ github.workspace }}\dist\profanity.exe" /NOLOGO /LIBPATH:"${{ github.workspace }}\Curl\lib" /LIBPATH:"${{ github.workspace }}\OpenCL\lib" OpenCL.lib libcurl_a.lib ws2_32.lib winmm.lib wldap32.lib crypt32.lib normaliz.lib kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.lib odbccp32.lib /MANIFEST /MANIFESTUAC:"level='asInvoker' uiAccess='false'" /manifest:embed /DEBUG:FULL /PDB:"${{ github.workspace }}\dist\profanity.pdb" /TLBID:1 /DYNAMICBASE /NXCOMPAT /IMPLIB:"${{ github.workspace }}\dist\profanity.lib" /MACHINE:X64 "${{ github.workspace }}\dist\*.obj"

      - name: "Build Assets"
        run: dir ${{ github.workspace }}/dist/*.*

      - name: "Compress"
        shell: powershell
        run: Compress-Archive -Path ${{ github.workspace }}/dist/profanity.exe,${{ github.workspace }}/dist/README.md,${{ github.workspace }}/dist/start.bat,${{ github.workspace }}/profanity.txt -Destination ${{ github.workspace }}/dist/windows.zip

      - uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ github.workspace }}/dist/windows.zip"
          token: ${{ secrets.GH_TOKEN }}
          tag: v1.0.0
          draft: true
          allowUpdates: true
          replacesArtifacts: true

  build_for_linux:
    name: "Build for Linux"
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: "Install Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ ocl-icd-opencl-dev libcurl4-openssl-dev

      - name: "Build"
        run: |
          g++ Dispatcher.cpp Mode.cpp precomp.cpp profanity.cpp SpeedSample.cpp \
            -I./Curl/include -I./OpenCL/include \
            -std=c++11 -Wall -mmmx -O2 -mcmodel=large \
            -s -lOpenCL -lcurl -mcmodel=large \
            -o profanity.x64

      - name: "Verify Build"
        run: |
          ls -lh profanity.x64
          file profanity.x64

      - name: "Compress"
        run: |
          mkdir -p dist
          tar -czf dist/linux.tar.gz profanity.x64 profanity.txt

      - uses: ncipollo/release-action@v1
        with:
          artifacts: "${{ github.workspace }}/dist/linux.tar.gz"
          token: ${{ secrets.GH_TOKEN }}
          tag: v1.0.0
          draft: true
          allowUpdates: true
          replacesArtifacts: true